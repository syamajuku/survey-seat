<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>運営用｜座席割り当て</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
      background:#f5f5f5; margin:0; padding:20px; color:#111;
    }
    h1{margin:0 0 12px 0; font-size:40px; font-weight:900;}
    h2{margin:24px 0 10px 0; font-size:22px;}

    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;}
    button{padding:10px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:800;}
    .btn-primary{background:#2563eb; color:#fff;}
    .btn-danger{background:#dc2626; color:#fff;}

    .meta{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:12px 14px; margin:10px 0 14px 0; font-size:14px;
    }

    /* ===== 4人がけテーブル表示 ===== */
    #seatResult{display:flex; flex-wrap:wrap; gap:14px;}
    .table{
      width:280px; background:#fafafa; border:2px solid #333; border-radius:12px;
      padding:12px;
    }
    .table-title{font-weight:900; text-align:center; margin-bottom:10px;}
    .row{display:flex; justify-content:space-between; margin-bottom:10px;}

    .seat{
      width:48%; min-height:48px;
      display:flex; align-items:center; justify-content:center;
      padding:12px 8px; border-radius:10px; box-sizing:border-box;
      font-weight:900; text-align:center; word-break:break-word;
    }
    .seat.pair{background:#dbeafe; border:2px solid #3b82f6;}
    .seat.solo{background:#fff7ed; border:2px dashed #f97316;}
    .seat.empty{background:#eee; border:2px dashed #ccc; color:#777;}

    /* ===== 回答一覧 ===== */
    .table-wrap{
      overflow-x:auto; background:#fff; border:1px solid #e5e7eb;
      border-radius:12px; padding:10px;
    }
    table{border-collapse:collapse; width:100%; min-width:820px; background:#fff;}
    th,td{border:1px solid #ddd; padding:10px 8px; font-size:13px; text-align:center; white-space:nowrap;}
    th{background:#f3f4f6; font-weight:900;}
    td.name{text-align:left; font-weight:900;}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; background:#fff; font-weight:900; font-size:12px;}
  </style>
</head>
<body>
  <h1>運営用｜座席割り当て</h1>

  <div class="controls">
    <button class="btn-primary" onclick="loadAll()">最新を読み込む</button>
    <button class="btn-danger" onclick="resetAll()">回答をリセット</button>
  </div>

  <div class="meta" id="metaBox">読み込み前です。「最新を読み込む」を押してください。</div>

  <div id="seatResult"></div>

  <h2>回答一覧</h2>
  <div class="table-wrap">
    <table id="answerTable">
      <thead>
        <tr>
          <th>#</th>
          <th>名前</th>
          <th>Q1</th>
          <th>Q2</th>
          <th>Q3</th>
          <th>Q4</th>
          <th>Q5（自慢）</th>
          <th>回答時刻</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const yn = (v) => (v === true ? "Yes" : v === false ? "No" : "");
    const safe = (v) => (v ?? "").toString();

    async function loadAll() {
      // ① 座席ブロック取得（あなたのAPI仕様に固定）
      const aRes = await fetch("/api/assignments", { cache: "no-store" });
      if (!aRes.ok) { alert("取得失敗: /api/assignments"); return; }
      const aJson = await aRes.json();
      const blocks = Array.isArray(aJson.blocks) ? aJson.blocks : [];

      // ② 回答一覧取得（あなたのAPI仕様に固定）
      const rRes = await fetch("/api/responses", { cache: "no-store" });
      if (!rRes.ok) { alert("取得失敗: /api/responses"); return; }
      const responses = await rRes.json();

      // メタ表示
      const meta = document.getElementById("metaBox");
      meta.innerHTML = `回答数：<strong>${safe(aJson.count ?? (Array.isArray(responses) ? responses.length : 0))}</strong> 名`;

      renderSeats(blocks);
      renderAnswers(Array.isArray(responses) ? responses : []);
    }

    async function resetAll() {
      if (!confirm("本当に全回答を削除しますか？")) return;
      const res = await fetch("/api/reset", { method: "POST" });
      if (!res.ok) { alert("リセット失敗: /api/reset"); return; }
      document.getElementById("seatResult").innerHTML = "";
      document.querySelector("#answerTable tbody").innerHTML = "";
      document.getElementById("metaBox").innerHTML = "リセットしました。";
    }

    // ===== 4
