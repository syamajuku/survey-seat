<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>運営用｜座席割り当て</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
      background:#f5f5f5; margin:0; padding:20px; color:#111;
    }
    h1{margin:0 0 12px 0; font-size:36px; font-weight:900;}
    h2{margin:26px 0 10px 0; font-size:22px;}

    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;}
    button{
      padding:10px 14px; border:none; border-radius:10px;
      cursor:pointer; font-weight:900;
    }
    .btn-primary{background:#2563eb; color:#fff;}
    .btn-secondary{background:#111827; color:#fff;}
    .btn-warning{background:#f59e0b; color:#111;}
    .btn-danger{background:#dc2626; color:#fff;}
    .btn-muted{background:#6b7280; color:#fff;}

    .meta{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:12px 14px; margin:10px 0 14px 0; font-size:14px;
    }
    .status-pill{
      display:inline-block; padding:3px 10px; border-radius:999px;
      font-weight:900; font-size:12px; margin-left:8px;
      border:1px solid #ddd; background:#fff;
    }
    .pill-on{border-color:#16a34a; color:#16a34a;}
    .pill-off{border-color:#dc2626; color:#dc2626;}

    /* ===== 質問編集 ===== */
    .card{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:12px 14px; margin:10px 0 14px 0;
    }
    .qgrid{
      display:grid; grid-template-columns: 1fr;
      gap:10px;
    }
    .qrow label{display:block; font-weight:900; margin-bottom:6px;}
    .qrow input{
      width:100%; box-sizing:border-box;
      padding:10px 12px; border:1px solid #d1d5db; border-radius:10px;
      font-size:14px;
    }
    .qhelp{font-size:12px; opacity:.8; margin-top:6px;}

    /* ===== テーブル表示 ===== */
    #seatResult{display:flex; flex-wrap:wrap; gap:14px;}
    .table{
      width:280px; background:#fafafa; border:2px solid #333;
      border-radius:12px; padding:12px;
    }
    .table-title{font-weight:900; text-align:center; margin-bottom:10px;}
    .row{display:flex; justify-content:space-between; margin-bottom:10px;}
    .seat{
      width:48%; min-height:54px;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      padding:8px; border-radius:10px; box-sizing:border-box;
      font-weight:900; text-align:center; word-break:break-word;
    }
    .seat.pair{background:#dbeafe; border:2px solid #3b82f6;}
    .seat.triad{background:#dcfce7; border:2px solid #16a34a;}
    .seat.solo{background:#fff7ed; border:2px dashed #f97316;}
    .seat.empty{background:#eee; border:2px dashed #ccc; color:#777;}
    .q5{font-size:12px; font-weight:700; opacity:.85; margin-top:2px;}

    /* ===== 回答一覧 ===== */
    .table-wrap{
      overflow-x:auto; background:#fff; border:1px solid #e5e7eb;
      border-radius:12px; padding:10px;
    }
    table{border-collapse:collapse; width:100%; min-width:860px;}
    th,td{border:1px solid #ddd; padding:8px 6px; font-size:13px; text-align:center; white-space:nowrap;}
    th{background:#f3f4f6; font-weight:900;}
    td.name{text-align:left; font-weight:900;}
    td.edit{min-width:160px;}
    .editbox{
      width:140px; padding:6px 8px; border:1px solid #d1d5db; border-radius:8px;
      font-size:13px;
    }
    .mini-btn{
      padding:6px 10px; border-radius:8px; font-weight:900; cursor:pointer; border:none;
      margin-left:6px;
    }
  </style>
</head>

<body>
  <h1>
    運営用｜座席割り当て
    <span id="pubPill" class="status-pill pill-off">未公開</span>
  </h1>

<div class="card" style="background:#f9fafb;">
  <h2 style="margin-top:0;">質問設計の全体像</h2>

  <ul style="padding-left:1.2em; line-height:1.7; font-size:14px;">
    <li>
      <strong>Q1・Q2：</strong>
      会話スタイル・価値観の「近さ／違い」を測る質問。<br/>
      → 回答が<strong>似ているほど相性が近い</strong>と判断します。
    </li>

    <li>
      <strong>Q3：</strong>
      今日のマッチング方針を決めるスイッチ。<br/>
      <ul>
        <li>Yes：<strong>違う傾向の人同士</strong>でペア（刺激・発見重視）</li>
        <li>No：<strong>似た傾向の人同士</strong>でペア（安心・話しやすさ重視）</li>
      </ul>
    </li>

    <li>
      <strong>Q4：</strong>
      会話が回るようにするための<strong>微調整用</strong>質問。<br/>
      → 聞き役同士／話す側同士にならないよう、<strong>席の左右を入れ替える</strong>ために使います。
    </li>

    <li>
      <strong>Q5：</strong>
      自己紹介のきっかけ（会話のフック）。<br/>
      → 長文はAIで要約され、テーブル表示に<strong>短く表示</strong>されます。
    </li>
  </ul>

  <div style="font-size:13px; color:#555; margin-top:10px;">
    ※ マッチングの主軸は Q1〜Q3、Q4 は補助的な調整、Q5 は会話促進のための情報です。
  </div>
</div>


  <div class="controls">
    <button class="btn-primary" onclick="loadAll()">最新を読み込む</button>
    <button class="btn-muted" onclick="loadQuestions()">質問を読み込む</button>
    <button class="btn-secondary" onclick="saveQuestions()">質問を保存</button>
    <button class="btn-warning" onclick="publishSeats(true)">座席を公開</button>
    <button class="btn-muted" onclick="publishSeats(false)">公開を解除</button>
    <button class="btn-danger" onclick="resetAll()">回答をリセット</button>
  </div>

  <div class="meta" id="metaBox">読み込み前です。「最新を読み込む」を押してください。</div>

  <!-- 質問編集 -->
  <div class="card">
    <h2 style="margin:0 0 10px 0;">質問文の編集（Q1〜Q5）</h2>
    <div class="qgrid">
      <div class="qrow">
        <label>Q1</label>
        <input id="q1" placeholder="例：自分から話題を出して会話をリードすることが好き" />
      </div>
      <div class="qrow">
        <label>Q2</label>
        <input id="q2" placeholder="例：会話では、過去の話よりも未来の夢の話をする方が好き" />
      </div>
      <div class="qrow">
        <label>Q3</label>
        <input id="q3" placeholder="例：今日は、価値観や考え方が違う人と話してみたい" />
      </div>
      <div class="qrow">
        <label>Q4</label>
        <input id="q4" placeholder="例：会話では、聞き役になることが多い" />
      </div>
      <div class="qrow">
        <label>Q5（自由記述）</label>
        <input id="q5" placeholder="例：自慢できること（短く）を書いてください" />
        <div class="qhelp">※参加者側の表示に反映されます。保存後、参加者側を強制リロードすると反映されます。</div>
      </div>
    </div>
  </div>

  <div id="seatResult"></div>
<hr />
<section style="margin:12px 0; padding:12px; border:1px dashed #bbb; border-radius:8px;">
  <h3 style="margin:0 0 8px 0;">未入力者を手動登録</h3>

  <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <input id="new-participant-name" type="text" placeholder="名前"
           style="padding:6px; min-width:180px;" />
    <button id="add-participant-btn">名簿に追加</button>
    <span id="add-participant-status" style="color:#666;"></span>
  </div>
</section>

<section id="unresponded-panel" style="padding:12px; border:1px solid #ddd; border-radius:8px; margin-top:12px;">
  <h3 style="margin:0 0 8px 0;">未入力者（未回答者）一覧</h3>

  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
    <input id="unresponded-filter" type="text" placeholder="検索（名前 / email）" style="padding:6px; min-width:240px;" />
    <button id="unresponded-reload">再読込</button>
    <span id="unresponded-status" style="color:#666;"></span>
  </div>

  <div style="overflow:auto;">
    <table style="border-collapse:collapse; width:100%; min-width:720px;">
      <thead>
        <tr>
          <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">名前</th>
          <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">email</th>
          <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">現在の手動席</th>
          <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">配置</th>
          <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">解除</th>
        </tr>
      </thead>
      <tbody id="unresponded-tbody"></tbody>
    </table>
  </div>
</section>

  <h2>回答一覧（Q5要約は編集できます）</h2>
  <div class="table-wrap">
    <table id="answerTable">
      <thead>
        <tr>
          <th>#</th>
          <th>名前</th>
          <th>Q1</th>
          <th>Q2</th>
          <th>Q3</th>
          <th>Q4</th>
          <th>Q5（要約）</th>
          <th>要約編集</th>
          <th>Q5（原文）</th>
          <th>回答時刻</th>
          <th>不参加</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/* ===== 共通 ===== */
const yn = (v) => (v === true ? "Yes" : v === false ? "No" : "");
const esc = (s) => String(s ?? "")
  .replaceAll("&","&amp;")
  .replaceAll("<","&lt;")
  .replaceAll(">","&gt;")
  .replaceAll('"',"&quot;")
  .replaceAll("'","&#39;");

/* ===== データ取得 ===== */
async function loadAll() {
  const aRes = await fetch("/api/assignments", { cache:"no-store" });
  if (!aRes.ok) { alert("取得失敗: /api/assignments"); return; }
  const aJson = await aRes.json();

  const rRes = await fetch("/api/responses", { cache:"no-store" });
  if (!rRes.ok) { alert("取得失敗: /api/responses"); return; }
  const rJson = await rRes.json();

  const rows = Array.isArray(rJson.rows) ? rJson.rows : [];
  const tables = Array.isArray(aJson.tables) ? aJson.tables : [];

  document.getElementById("metaBox").innerHTML = `回答数：<strong>${rows.length}</strong> 名`;

  renderTables(tables);
  renderAnswers(rows);

  // 公開状態も表示（失敗しても座席表示はできるようにする）
  try {
    const st = await fetch("/api/publish", { cache:"no-store" }).then(r=>r.json());
    setPill(Boolean(st.published));
  } catch {}
}

/* ===== 公開状態 pill ===== */
function setPill(published){
  const pill = document.getElementById("pubPill");
  if (published){
    pill.textContent = "公開中";
    pill.classList.remove("pill-off");
    pill.classList.add("pill-on");
  } else {
    pill.textContent = "未公開";
    pill.classList.remove("pill-on");
    pill.classList.add("pill-off");
  }
}

/* ===== 質問の読み込み/保存 ===== */
async function loadQuestions(){
  const r = await fetch("/api/questions", { cache:"no-store" });
  if (!r.ok){ alert("質問の取得に失敗しました"); return; }
  const j = await r.json();
  const q = j.questions || {};
  document.getElementById("q1").value = q.q1 || "";
  document.getElementById("q2").value = q.q2 || "";
  document.getElementById("q3").value = q.q3 || "";
  document.getElementById("q4").value = q.q4 || "";
  document.getElementById("q5").value = q.q5 || "";
  alert("質問を読み込みました");
}

async function saveQuestions(){
  const body = {
    q1: document.getElementById("q1").value,
    q2: document.getElementById("q2").value,
    q3: document.getElementById("q3").value,
    q4: document.getElementById("q4").value,
    q5: document.getElementById("q5").value,
  };
  const r = await fetch("/api/questions", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if (!r.ok){ alert("質問の保存に失敗しました"); return; }
  alert("質問を保存しました（参加者側は強制リロードで反映）");
}

/* ===== 座席公開/解除 ===== */
async function publishSeats(on){
  const r = await fetch("/api/publish", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ publish: !!on })
  });
  if (!r.ok){ alert("公開状態の更新に失敗しました"); return; }
  const j = await r.json();
  setPill(Boolean(j.published));
  alert(on ? "座席を公開しました" : "公開を解除しました");
}

/* ===== 座席描画 ===== */
function renderTables(tables){
  const root = document.getElementById("seatResult");
  root.innerHTML = "";

  if (!tables.length){
    root.innerHTML = `<div class="meta">座席データがまだありません（回答が1名の場合でも表示されるはずです）</div>`;
    return;
  }

  for (const t of tables){
    const el = document.createElement("div");
    el.className = "table";
    el.innerHTML = `
      <div class="table-title">テーブル ${t.tableNo}</div>
      <div class="row">
        ${seatCell(findSeat(t.seats,"左上"))}
        ${seatCell(findSeat(t.seats,"右上"))}
      </div>
      <div class="row">
        ${seatCell(findSeat(t.seats,"左下"))}
        ${seatCell(findSeat(t.seats,"右下"))}
      </div>
    `;
    root.appendChild(el);
  }
}

function findSeat(seats,pos){
  return (seats||[]).find(s=>s.pos===pos) || { empty:true };
}

function seatCell(seat){
  if (seat.empty){
    return `<div class="seat empty">空席</div>`;
  }
  const type = seat.blockType || "pair";
  return `
    <div class="seat ${type}">
      <div>${esc(seat.name)}</div>
      <div class="q5">${esc(seat.q5 || "")}</div>
    </div>
  `;
}

/* ===== 回答一覧（Q5要約の編集） ===== */
/* ===== 回答一覧（Q5要約の編集） ===== */
function renderAnswers(rows){
  const tb = document.querySelector("#answerTable tbody");
  tb.innerHTML = "";

  rows.forEach((r,i)=>{
    const id = esc(r.id || "");
    const short = esc(r.q5_short || "");
    const original = esc(r.q5 || "");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="name">${esc(r.name)}</td>
      <td>${yn(r.q1)}</td>
      <td>${yn(r.q2)}</td>
      <td>${yn(r.q3)}</td>
      <td>${yn(r.q4)}</td>
      <td>${short}</td>

      <td class="edit">
        <input class="editbox" id="q5s_${id}" value="${short}" maxlength="12" />
        <button class="mini-btn btn-secondary" onclick="saveQ5Short('${id}')">保存</button>
      </td>

      <td>${original}</td>
      <td>${esc(r.created_at || "")}</td>

      <td>
        <button class="mini-btn btn-danger" onclick="markAbsent('${id}')">不参加</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

async function markAbsent(id){
  if(!confirm("この参加者を不参加にしますか？")) return;

  const r = await fetch("/api/responses/absent", {
    method: "PATCH",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ id, is_absent: true })
  });

  if (!r.ok){
    alert("不参加処理に失敗しました");
    return;
  }

  alert("不参加にしました");
  loadAll();
}

async function saveQ5Short(id){
  const v = document.getElementById("q5s_" + id)?.value ?? "";
  const r = await fetch("/api/q5short", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ id, q5_short: v })
  });
  if (!r.ok){ alert("要約の保存に失敗しました"); return; }
  alert("要約を保存しました");
  // 反映を確認したい場合は loadAll() を押す
}

/* ===== リセット ===== */
async function resetAll(){
  if(!confirm("本当に全回答を削除しますか？（公開も解除されます）")) return;
  const r = await fetch("/api/reset",{method:"POST"});
  if(!r.ok){ alert("リセット失敗"); return; }
  document.getElementById("seatResult").innerHTML="";
  document.querySelector("#answerTable tbody").innerHTML="";
  document.getElementById("metaBox").innerText="リセットしました。";
  setPill(false);
}

// 初回自動ロード
window.addEventListener("load", () => {
  loadAll().catch(() => {});
});

</script>
<script src="/unresponded.js?v=202601091610"></script>

</body>
</html>
