<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>運営用｜座席割り当て</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
      background:#f5f5f5; margin:0; padding:20px; color:#111;
    }
    h1{margin:0 0 12px 0; font-size:36px; font-weight:900;}
    h2{margin:26px 0 10px 0; font-size:22px;}

    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;}
    button{
      padding:10px 14px; border:none; border-radius:10px;
      cursor:pointer; font-weight:800;
    }
    .btn-primary{background:#2563eb; color:#fff;}
    .btn-danger{background:#dc2626; color:#fff;}

    .meta{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:12px 14px; margin:10px 0 14px 0; font-size:14px;
    }

    /* ===== テーブル表示 ===== */
    #seatResult{display:flex; flex-wrap:wrap; gap:14px;}

    .table{
      width:280px; background:#fafafa; border:2px solid #333;
      border-radius:12px; padding:12px;
    }
    .table-title{
      font-weight:900; text-align:center; margin-bottom:10px;
    }
    .row{
      display:flex; justify-content:space-between; margin-bottom:10px;
    }

    .seat{
      width:48%; min-height:54px;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      padding:8px; border-radius:10px;
      box-sizing:border-box;
      font-weight:900; text-align:center;
      word-break:break-word;
    }
    .seat.pair{background:#dbeafe; border:2px solid #3b82f6;}
    .seat.triad{background:#dcfce7; border:2px solid #16a34a;}
    .seat.solo{background:#fff7ed; border:2px dashed #f97316;}
    .seat.empty{background:#eee; border:2px dashed #ccc; color:#777;}

    .q5{
      font-size:12px; font-weight:700; opacity:.8; margin-top:2px;
    }

    /* ===== 回答一覧 ===== */
    .table-wrap{
      overflow-x:auto; background:#fff; border:1px solid #e5e7eb;
      border-radius:12px; padding:10px;
    }
    table{border-collapse:collapse; width:100%; min-width:820px;}
    th,td{
      border:1px solid #ddd; padding:8px 6px;
      font-size:13px; text-align:center; white-space:nowrap;
    }
    th{background:#f3f4f6; font-weight:900;}
    td.name{text-align:left; font-weight:900;}
  </style>
</head>

<body>
  <h1>運営用｜座席割り当て</h1>

  <div class="controls">
    <button class="btn-primary" onclick="loadAll()">最新を読み込む</button>
    <button class="btn-danger" onclick="resetAll()">回答をリセット</button>
  </div>

  <div class="meta" id="metaBox">
    読み込み前です。「最新を読み込む」を押してください。
  </div>

  <div id="seatResult"></div>

  <h2>回答一覧</h2>
  <div class="table-wrap">
    <table id="answerTable">
      <thead>
        <tr>
          <th>#</th>
          <th>名前</th>
          <th>Q1</th>
          <th>Q2</th>
          <th>Q3</th>
          <th>Q4</th>
          <th>Q5（要約）</th>
          <th>回答時刻</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/* ===== 共通 ===== */
const yn = (v) => (v === true ? "Yes" : v === false ? "No" : "");
const safe = (v) => (v ?? "").toString();
const esc = (s) => String(s ?? "")
  .replaceAll("&","&amp;")
  .replaceAll("<","&lt;")
  .replaceAll(">","&gt;")
  .replaceAll('"',"&quot;")
  .replaceAll("'","&#39;");

/* ===== データ取得 ===== */
async function loadAll() {
  const aRes = await fetch("/api/assignments", { cache:"no-store" });
  if (!aRes.ok) { alert("取得失敗: /api/assignments"); return; }
  const aJson = await aRes.json();

  const rRes = await fetch("/api/responses", { cache:"no-store" });
  if (!rRes.ok) { alert("取得失敗: /api/responses"); return; }
  const rJson = await rRes.json();

  const rows = Array.isArray(rJson.rows) ? rJson.rows : [];
  const tables = Array.isArray(aJson.tables) ? aJson.tables : [];

  document.getElementById("metaBox").innerHTML =
    `回答数：<strong>${rows.length}</strong> 名`;

  renderTables(tables);
  renderAnswers(rows);
}

/* ===== 座席描画 ===== */
function renderTables(tables){
  const root = document.getElementById("seatResult");
  root.innerHTML = "";

  if (!tables.length){
    root.innerHTML = `<div class="meta">座席データがまだありません</div>`;
    return;
  }

  for (const t of tables){
    const el = document.createElement("div");
    el.className = "table";
    el.innerHTML = `
      <div class="table-title">テーブル ${t.tableNo}</div>
      <div class="row">
        ${seatCell(findSeat(t.seats,"左上"))}
        ${seatCell(findSeat(t.seats,"右上"))}
      </div>
      <div class="row">
        ${seatCell(findSeat(t.seats,"左下"))}
        ${seatCell(findSeat(t.seats,"右下"))}
      </div>
    `;
    root.appendChild(el);
  }
}

function findSeat(seats,pos){
  return (seats||[]).find(s=>s.pos===pos) || { empty:true };
}

function seatCell(seat){
  if (seat.empty){
    return `<div class="seat empty">空席</div>`;
  }
  const type = seat.blockType || "pair";
  return `
    <div class="seat ${type}">
      <div>${esc(seat.name)}</div>
      <div class="q5">${esc(seat.q5)}</div>
    </div>
  `;
}

/* ===== 回答一覧 ===== */
function renderAnswers(rows){
  const tb = document.querySelector("#answerTable tbody");
  tb.innerHTML = "";
  rows.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="name">${esc(r.name)}</td>
      <td>${yn(r.q1)}</td>
      <td>${yn(r.q2)}</td>
      <td>${yn(r.q3)}</td>
      <td>${yn(r.q4)}</td>
      <td>${esc(r.q5_short || "")}</td>
      <td>${esc(r.created_at || "")}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== リセット ===== */
async function resetAll(){
  if(!confirm("本当に全回答を削除しますか？")) return;
  const r = await fetch("/api/reset",{method:"POST"});
  if(!r.ok){ alert("リセット失敗"); return; }
  document.getElementById("seatResult").innerHTML="";
  document.querySelector("#answerTable tbody").innerHTML="";
  document.getElementById("metaBox").innerText="リセットしました。";
}
</script>
</body>
</html>
