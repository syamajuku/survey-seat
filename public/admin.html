<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>運営用｜座席割り当て</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }

    h1 {
      margin-bottom: 10px;
    }

    button {
      padding: 8px 14px;
      margin-right: 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    /* ===== テーブル表示 ===== */
    #seatResult {
      display: flex;
      flex-wrap: wrap;
    }

    .table {
      border: 2px solid #333;
      border-radius: 10px;
      padding: 12px;
      margin: 16px;
      width: 260px;
      background: #fafafa;
    }

    .table-title {
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .seat {
      width: 48%;
      padding: 12px 6px;
      text-align: center;
      border-radius: 6px;
      font-weight: bold;
      box-sizing: border-box;
    }

    .seat.pair {
      background: #dbeafe;
      border: 2px solid #3b82f6;
    }

    .seat.solo {
      background: #fff7ed;
      border: 2px dashed #f97316;
    }

    .seat.empty {
      background: #eee;
      border: 2px dashed #ccc;
      color: #999;
    }

    /* ===== 回答一覧 ===== */
    table {
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 12px;
      text-align: center;
    }

    th {
      background: #f0f0f0;
    }
  </style>
</head>

<body>
  <h1>運営用｜座席割り当て</h1>

  <div style="margin-bottom:12px;">
    <button class="btn-primary" onclick="loadSeats()">座席を生成</button>
    <button class="btn-danger" onclick="resetData()">回答をリセット</button>
  </div>

  <!-- ===== 座席表示 ===== -->
  <div id="seatResult"></div>

  <!-- ===== 回答一覧 ===== -->
  <h2>回答一覧</h2>
  <table id="answerTable">
    <thead>
      <tr>
        <th>名前</th>
        <th>Q1</th>
        <th>Q2</th>
        <th>Q3</th>
        <th>Q4</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadSeats() {
      const res = await fetch("/api/seats");
      const data = await res.json();

      renderSeats(data.pairs);
      renderAnswers(data.responses);
    }

    async function resetData() {
      if (!confirm("本当に全回答を削除しますか？")) return;
      await fetch("/api/reset", { method: "POST" });
      document.getElementById("seatResult").innerHTML = "";
      document.querySelector("#answerTable tbody").innerHTML = "";
    }

    /* ===== 座席描画 ===== */
    function renderSeats(pairs) {
      const container = document.getElementById("seatResult");
      container.innerHTML = "";

      let tableNumber = 1;

      for (let i = 0; i < pairs.length; i += 2) {
        const topPair = pairs[i];
        const bottomPair = pairs[i + 1];

        const table = document.createElement("div");
        table.className = "table";

        table.innerHTML = `
          <div class="table-title">テーブル ${tableNumber}</div>

          <div class="row">
            ${renderSeat(topPair, 0)}
            ${renderSeat(topPair, 1)}
          </div>

          <div class="row">
            ${renderSeat(bottomPair, 0)}
            ${renderSeat(bottomPair, 1)}
          </div>
        `;

        container.appendChild(table);
        tableNumber++;
      }
    }

    function renderSeat(pair, index) {
      if (!pair || !pair.members[index]) {
        return `<div class="seat empty">空席</div>`;
      }

      const member = pair.members[index];
      const seatClass =
        pair.members.length === 3 && index === 0
          ? "seat solo"
          : "seat pair";

      return `<div class="${seatClass}">${member.name}</div>`;
    }

    /* ===== 回答一覧描画 ===== */
    function renderAnswers(responses) {
      const tbody = document.querySelector("#answerTable tbody");
      tbody.innerHTML = "";

      responses.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.q1 ? "Yes" : "No"}</td>
          <td>${r.q2 ? "Yes" : "No"}</td>
          <td>${r.q3 ? "Yes" : "No"}</td>
          <td>${r.q4 ? "Yes" : "No"}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
