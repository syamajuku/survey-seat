<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>アンケート</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --danger:#dc2626;
      --yes:#16a34a;
      --no:#64748b;
    }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
    }
    .wrap{ max-width:560px; margin:0 auto; padding:18px; }
    h1{ font-size:22px; margin:6px 0 12px; font-weight:900; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 1px 0 rgba(0,0,0,0.03);
      margin-bottom:12px;
    }

    .label{ font-weight:900; margin:8px 0 6px; }
    .hint{ color:var(--muted); font-size:12px; line-height:1.4; }

    input[type="text"], textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      font-size:16px;
      box-sizing:border-box;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:86px; resize:vertical; }

    .qbox{ padding:10px 0 4px; }
    .qtitle{ font-weight:900; margin-bottom:10px; line-height:1.4; }

    .yn{ display:flex; gap:10px; }
    .btnYN{
      flex:1;
      padding:12px 10px;
      border-radius:12px;
      border:2px solid var(--border);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      font-size:16px;
    }
    .btnYN.active-yes{ border-color:var(--yes); color:var(--yes); background:#ecfdf5; }
    .btnYN.active-no{ border-color:var(--no); color:var(--no); background:#f8fafc; }

    .footer{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btn{
      width:100%;
      padding:14px 12px;
      border-radius:14px;
      border:none;
      font-weight:900;
      cursor:pointer;
      font-size:16px;
    }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-primary:disabled{ opacity:.5; cursor:not-allowed; }

    .msg{ margin-top:10px; font-weight:900; }
    .ok{ color:var(--yes); }
    .ng{ color:var(--danger); }

    /* ===== 4人がけテーブル表示（参加者用） ===== */
    .table{
      width:280px; background:#fafafa; border:2px solid #333; border-radius:12px;
      padding:12px; margin:0 auto;
    }
    .table-title{font-weight:900; text-align:center; margin-bottom:10px;}
    .row{display:flex; justify-content:space-between; margin-bottom:10px;}
    .seat{
      width:48%; min-height:58px;
      display:flex; align-items:center; justify-content:center;
      padding:10px 8px; border-radius:10px; box-sizing:border-box;
      font-weight:900; text-align:center; word-break:break-word;
      flex-direction:column;
    }
    .seat.pair{background:#dbeafe; border:2px solid #3b82f6;}
    .seat.solo{background:#fff7ed; border:2px dashed #f97316;}
    .seat.empty{background:#eee; border:2px dashed #ccc; color:#777; font-weight:800;}
    .seat.me{outline:4px solid #111827;}
    .seat .brag{margin-top:4px; font-size:12px; font-weight:800; opacity:.85;}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>アンケート（所要時間：約1分）</h1>

    <!-- 名前 -->
    <div class="card">
      <div class="label">お名前</div>
      <input id="name" type="text" placeholder="例：山田 太郎" />
    </div>

    <!-- Q1〜Q4 -->
    <div class="card">
      <div class="label">質問（Yes / No）</div>

      <div class="qbox">
        <div class="qtitle" id="q1Text">Q1の質問文</div>
        <div class="yn">
          <button class="btnYN" id="q1Yes" onclick="setYN('q1', true)">Yes</button>
          <button class="btnYN" id="q1No"  onclick="setYN('q1', false)">No</button>
        </div>
      </div>

      <div class="qbox">
        <div class="qtitle" id="q2Text">Q2の質問文</div>
        <div class="yn">
          <button class="btnYN" id="q2Yes" onclick="setYN('q2', true)">Yes</button>
          <button class="btnYN" id="q2No"  onclick="setYN('q2', false)">No</button>
        </div>
      </div>

      <div class="qbox">
        <div class="qtitle" id="q3Text">Q3の質問文</div>
        <div class="yn">
          <button class="btnYN" id="q3Yes" onclick="setYN('q3', true)">Yes</button>
          <button class="btnYN" id="q3No"  onclick="setYN('q3', false)">No</button>
        </div>
      </div>

      <div class="qbox">
        <div class="qtitle" id="q4Text">Q4の質問文</div>
        <div class="yn">
          <button class="btnYN" id="q4Yes" onclick="setYN('q4', true)">Yes</button>
          <button class="btnYN" id="q4No"  onclick="setYN('q4', false)">No</button>
        </div>
      </div>
    </div>

    <!-- Q5 + 送信 -->
    <div class="card">
      <div class="label" id="q5Label"></div>
      <textarea id="q5" placeholder="例：○○が得意（6文字以上の場合はAIが5文字以下に自動編集して表示します）"></textarea>

      <div class="footer">
        <button id="submitBtn" class="btn btn-primary" onclick="submitForm()">送信する</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>

    <!-- 座席表示（参加者） -->
    <div id="seatBox" class="card" style="display:none;">
      <!-- seatMeta は内部処理用（表示はしない） -->
      <div id="seatMeta" style="display:none;"></div>
      <div id="seatResult"></div>
    </div>

  </div>

  <script>
    // Yes/No回答を保持
    const state = { q1:null, q2:null, q3:null, q4:null };

    function setYN(key, val){
      state[key] = val;
      const yesBtn = document.getElementById(key + "Yes");
      const noBtn  = document.getElementById(key + "No");

      yesBtn.classList.remove("active-yes");
      noBtn.classList.remove("active-no");

      if(val === true) yesBtn.classList.add("active-yes");
      if(val === false) noBtn.classList.add("active-no");
    }

    async function loadQuestions(){
      try{
        const res = await fetch("/api/questions", { cache: "no-store" });
        const json = await res.json().catch(()=>({}));
        if(!json.ok) return;
        const q = json.questions || {};
        const setText = (id, text) => {
          const el = document.getElementById(id);
          if(el) el.textContent = text || "";
        };
        setText("q1Text", q.q1);
        setText("q2Text", q.q2);
        setText("q3Text", q.q3);
        setText("q4Text", q.q4);
        const q5Label = document.getElementById("q5Label");
        if(q5Label) q5Label.textContent = q.q5 || "";
      }catch(e){}
    }

    function showMsg(text, ok){
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = "msg " + (ok ? "ok" : "ng");
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    async function submitForm(){
      const name = document.getElementById("name").value.trim();
      const q5 = document.getElementById("q5").value.trim();

      if(!name){ showMsg("お名前を入力してください。", false); return; }
      for(const k of ["q1","q2","q3","q4"]){
        if(state[k] === null){
          showMsg("Q1〜Q4をすべて選択してください。", false);
          return;
        }
      }
      if(!q5){
        showMsg("Q5を入力してください。", false);
        return;
      }

      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      showMsg("送信中…", true);

      try{
        const res = await fetch("/api/responses", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            name,
            q1: state.q1, q2: state.q2, q3: state.q3, q4: state.q4,
            q5
          })
        });

        const json = await res.json().catch(()=>({}));

        if(!res.ok || !json.ok){
          showMsg(json.error || "送信に失敗しました。", false);
        }else{
          // 自分のIDを保存（座席表示に必須）
          if(json.record && json.record.id){
            const id = json.record.id;
            localStorage.setItem("surveySeat_userId", id);

            // URLにも埋め込む（ページを閉じても復帰できる）
            const url = new URL(location.href);
            url.searchParams.set("id", id);
            history.replaceState(null, "", url.toString());
          }

          showMsg("送信しました。", true);

          // 入力をリセット（名前は残す運用）
          document.getElementById("q5").value = "";
          for(const k of ["q1","q2","q3","q4"]){ state[k]=null; }
          ["q1","q2","q3","q4"].forEach(k=>{
            document.getElementById(k+"Yes").classList.remove("active-yes");
            document.getElementById(k+"No").classList.remove("active-no");
          });

          // すぐ座席チェック（未公開なら空のまま）
          checkSeat();
        }
      }catch(e){
        showMsg("送信に失敗しました。", false);
      }finally{
        btn.disabled = false;
      }
    }

async function checkSeat(){
  // URL ?id= を優先し、なければ localStorage（idが無くても表示はする）
  const url = new URL(location.href);
  const idFromUrl = url.searchParams.get("id");
  const id = idFromUrl || localStorage.getItem("surveySeat_userId") || "";

  // URLにidがあれば localStorageにも保存（復帰用）
  if(idFromUrl) localStorage.setItem("surveySeat_userId", idFromUrl);

  const box = document.getElementById("seatBox");
  const out = document.getElementById("seatResult");
  if(!box || !out) return;

  try{
    // 全席表示エリアは常に出す（未公開なら中身は空）
    box.style.display = "block";

    // 1) まず公開状態を確認（未公開なら何も表示しない）
    const stRes = await fetch("/api/publish", { cache:"no-store" });
    const stJson = await stRes.json().catch(()=>({}));
    if(!stRes.ok || !stJson.ok || stJson.published !== true){
      out.innerHTML = "";
      return;
    }

    // 2) 公開中：全席を取得
    const res = await fetch("/api/assignments", { cache: "no-store" });
    const json = await res.json().catch(()=>({}));
    if(!res.ok || !json.ok) { out.innerHTML = ""; return; }

    const tables = Array.isArray(json.tables) ? json.tables : [];
    if(!tables.length) { out.innerHTML = ""; return; }

    out.innerHTML = tables.map(t => {
      const tableNo = t.tableNo;
      const seats = Array.isArray(t.seats) ? t.seats : [];
      const seatByPos = new Map(seats.map(s => [s.pos, s]));

      const seatHtml = (pos) => {
        const s = seatByPos.get(pos);
        if(!s || s.empty) return `<div class="seat empty">空席</div>`;

        const clsBase = (s.blockType === "triad") ? "seat solo" : "seat pair";
        const clsMe = (id && s.id === id) ? " me" : "";
        const name = escapeHtml(s.name);
        const brag = escapeHtml(s.q5 || "");

        return `
          <div class="${clsBase}${clsMe}">
            <div style="font-weight:900; line-height:1.1;">${name}</div>
            ${brag ? `<div class="brag">${brag}</div>` : ``}
          </div>
        `;
      };

      return `
        <div class="table">
          <div class="table-title">テーブル ${tableNo}</div>
          <div class="row">
            ${seatHtml("左上")}
            ${seatHtml("右上")}
          </div>
          <div class="row">
            ${seatHtml("左下")}
            ${seatHtml("右下")}
          </div>
        </div>
      `;
    }).join("");
  }catch(e){
    out.innerHTML = "";
  }
}

    // 初期化
    window.addEventListener("DOMContentLoaded", () => {
      loadQuestions();
      checkSeat();
    });

    // 5秒おきに座席公開を確認（公開されたら表示される）
    setInterval(checkSeat, 5000);
  </script>
</body>
</html>
